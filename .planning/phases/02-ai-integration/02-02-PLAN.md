---
phase: 02-ai-integration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - client/src/state/canvasStore.ts
  - client/src/components/canvas/nodes/SnowballNode.tsx
  - client/src/components/canvas/InfiniteCanvas.tsx
  - client/src/components/ui/HoverTooltip.tsx
  - client/src/components/ui/DemoToggle.tsx
  - client/src/App.tsx
  - client/src/config/api.ts
autonomous: false

must_haves:
  truths:
    - "User clicks a snowball node and 4 new child nodes appear with animated expansion"
    - "User hovers a node and sees an AI-generated fun fact tooltip after a short delay"
    - "Quiz data is embedded in each child node's data (no separate API call for quizzes)"
    - "Demo mode toggle switches between live API calls and pre-cached responses"
    - "Expanded nodes show a visual indicator that they have been explored"
  artifacts:
    - path: "client/src/state/canvasStore.ts"
      provides: "Canvas store with expandNode and hoverFact async actions"
      exports: ["useCanvasStore"]
    - path: "client/src/components/canvas/nodes/SnowballNode.tsx"
      provides: "Interactive snowball node with click-to-expand and hover tooltip"
      min_lines: 40
    - path: "client/src/components/ui/HoverTooltip.tsx"
      provides: "Tooltip component showing fun facts on hover"
      min_lines: 20
    - path: "client/src/components/ui/DemoToggle.tsx"
      provides: "Toggle switch for demo mode in HUD"
      min_lines: 15
    - path: "client/src/config/api.ts"
      provides: "API base URL and demo mode data"
      exports: ["API_BASE", "DEMO_DATA"]
  key_links:
    - from: "client/src/components/canvas/nodes/SnowballNode.tsx"
      to: "client/src/state/canvasStore.ts"
      via: "expandNode action"
      pattern: "expandNode"
    - from: "client/src/state/canvasStore.ts"
      to: "server /api/scout"
      via: "fetch POST"
      pattern: "fetch.*api/scout"
    - from: "client/src/state/canvasStore.ts"
      to: "server /api/hover"
      via: "fetch POST"
      pattern: "fetch.*api/hover"
    - from: "client/src/components/ui/DemoToggle.tsx"
      to: "client/src/state/canvasStore.ts"
      via: "demo mode state"
      pattern: "demoMode"
---

<objective>
Wire the frontend to the backend API: clicking nodes expands sub-topics, hovering shows fun facts, and demo mode enables offline presentation.

Purpose: This transforms FRACTAL from a static seed-data canvas into a dynamic AI-powered knowledge explorer. Clicking any node generates 4 child nodes with embedded quizzes, hovering reveals fun facts, and demo mode ensures the hackathon demo works without live API dependency.

Output: Interactive canvas where clicking nodes triggers AI-generated sub-topics (with loading state), hovering shows tooltips with fun facts, and a demo mode toggle in the HUD switches to pre-cached responses.
</objective>

<execution_context>
@/Users/sahilpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sahilpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-integration/02-01-SUMMARY.md
@client/src/state/canvasStore.ts
@client/src/components/canvas/nodes/SnowballNode.tsx
@client/src/components/canvas/InfiniteCanvas.tsx
@client/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update canvas store with async expand/hover actions and demo mode</name>
  <files>
    client/src/config/api.ts
    client/src/state/canvasStore.ts
  </files>
  <action>
    1. Create src/config/api.ts:
       - Export API_BASE = 'http://localhost:3000/api' (or from env var VITE_API_URL)
       - Export DEMO_DATA object with pre-cached responses for 5-7 common topics:
         - "The Universe" -> 4 sub-topics (Galaxies, Dark Matter, Big Bang Theory, Cosmic Microwave Background) with quiz data
         - "Galaxies" -> 4 sub-topics with quiz data
         - "Dark Matter" -> 4 sub-topics with quiz data
         - Each sub-topic has: label (string), quiz ({ question, options: string[4], correctIndex: 0-3 } or null)
         - Fun facts for each of these topics (1-2 sentence educational facts)
       - Export type SubTopic = { label: string, quiz: QuizData | null }
       - Export type QuizData = { question: string, options: string[], correctIndex: number }

    2. Rewrite src/state/canvasStore.ts:
       - Keep existing initialNodes and initialEdges (seed data unchanged)
       - Keep onNodesChange and onEdgesChange handlers
       - Add state:
         - isExpanding: boolean (loading state for node expansion)
         - expandingNodeId: string | null (which node is loading)
         - hoveredFact: { nodeId: string, fact: string } | null
         - isLoadingFact: boolean
         - demoMode: boolean (default: false)
         - error: string | null
         - expandedNodeIds: Set<string> (track which nodes have been expanded, serialized as string[] in zustand)
       - Add actions:
         - toggleDemoMode(): flip demoMode
         - expandNode(nodeId: string, topic: string): async
           a. If nodeId already in expandedNodeIds, return early (prevent double-expand)
           b. Set isExpanding=true, expandingNodeId=nodeId
           c. If demoMode: look up topic in DEMO_DATA, use pre-cached response
           d. Else: POST to /api/scout with { topic }, parse response
           e. Generate unique IDs for new nodes: `${nodeId}-${index}` format
           f. Position new nodes in a fan below parent:
              - Get parent position
              - Spread 4 children horizontally: x = parentX + (i - 1.5) * 200, y = parentY + 180
           g. Create new Node[] (type: 'snowball') and Edge[] (type: 'footprint')
           h. Each new node's data: { label: subTopic.label, quiz: subTopic.quiz, parentTopic: topic }
           i. Append new nodes/edges to existing
           j. Add nodeId to expandedNodeIds
           k. Set isExpanding=false, expandingNodeId=null
           l. On error: set error message, isExpanding=false
         - fetchFunFact(nodeId: string, topic: string): async
           a. Set isLoadingFact=true
           b. If demoMode: look up in DEMO_DATA fun facts
           c. Else: POST to /api/hover with { topic }
           d. Set hoveredFact = { nodeId, fact }
           e. Set isLoadingFact=false
           f. On error: set hoveredFact with generic message
         - clearHoveredFact(): set hoveredFact=null
  </action>
  <verify>
    cd client && npx tsc --noEmit
    Verify: TypeScript compiles, no type errors. Store exports all needed actions.
  </verify>
  <done>Canvas store has expandNode, fetchFunFact, toggleDemoMode actions. Demo mode uses pre-cached data. Expanded nodes tracked to prevent double-expand. Loading states managed.</done>
</task>

<task type="auto">
  <name>Task 2: Update SnowballNode with click/hover, add HoverTooltip and DemoToggle</name>
  <files>
    client/src/components/canvas/nodes/SnowballNode.tsx
    client/src/components/ui/HoverTooltip.tsx
    client/src/components/ui/DemoToggle.tsx
    client/src/components/canvas/InfiniteCanvas.tsx
    client/src/App.tsx
  </files>
  <action>
    1. Rewrite src/components/canvas/nodes/SnowballNode.tsx:
       - Keep React.memo wrapper and Handle components
       - Import useCanvasStore (select individual slices for performance)
       - On click: call expandNode(id, data.label) if not already expanding and not already expanded
       - On mouseEnter: start 500ms debounce timer, then call fetchFunFact(id, data.label)
       - On mouseLeave: clear timer, call clearHoveredFact()
       - Visual states:
         - Default: current snowball styling (rounded-2xl bg-white/90)
         - Expanded: slightly dimmed border or checkmark indicator (e.g., border-amber-300/50)
         - Expanding (loading): pulse animation via Tailwind animate-pulse on the node
         - Has quiz: small sparkle/snowflake indicator in top-right corner (use a simple ❄ character or CSS dot)
       - Show expand indicator on bottom of unexpanded nodes (small "+" or down-arrow)
       - Cursor: pointer when expandable, default when already expanded, wait when loading

    2. Create src/components/ui/HoverTooltip.tsx:
       - Reads hoveredFact and isLoadingFact from canvasStore
       - Positioned absolutely in the canvas container
       - When hoveredFact exists: render tooltip near the hovered node
         - Use React Flow's useReactFlow() hook to get viewport transform (not needed if positioned via CSS near node)
         - Actually: render as part of SnowballNode (absolute positioned div below the node)
         - Styling: bg-slate-800/95 text-frost text-xs rounded-lg px-3 py-2 max-w-[250px] shadow-lg backdrop-blur-sm
         - Loading state: "Loading..." with subtle pulse
         - Animate in with framer-motion (opacity + translateY)
       - Export as named export

    3. Create src/components/ui/DemoToggle.tsx:
       - Import useCanvasStore for demoMode and toggleDemoMode
       - Render a toggle switch in the HUD area
       - Label: "Demo Mode" with on/off indicator
       - Styling: matches the HUD aesthetic (frost/amber colors, small, subtle)
         - Container: bg-slate-800/60 backdrop-blur-sm rounded-lg px-3 py-1.5
         - Label: text-xs font-body text-frost/60
         - Toggle: small circle that slides left/right, amber when on, slate when off
       - Export as named export

    4. Update src/components/canvas/InfiniteCanvas.tsx:
       - No major changes needed unless tooltip rendering requires canvas-level component
       - If SnowballNode handles its own tooltip positioning, no changes here

    5. Update src/App.tsx:
       - Add DemoToggle component to the HUD area (fixed position, top-right)
       - Keep existing FRACTAL title/subtitle in top-left
       - Add DemoToggle: fixed top-8 right-8, pointer-events-auto, z-index var(--z-hud)
  </action>
  <verify>
    cd client && npx tsc --noEmit && npm run build
    Verify: TypeScript compiles, Vite build succeeds.
    Open browser: click node to expand, hover to see tooltip, toggle demo mode.
  </verify>
  <done>Clicking a snowball node triggers expansion with 4 new child nodes. Hovering shows fun fact tooltip. Demo mode toggle in HUD switches to pre-cached data. Visual states (loading, expanded, has-quiz) are clear.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full AI-powered knowledge exploration: click nodes to expand sub-topics, hover for fun facts, demo mode toggle.</what-built>
  <how-to-verify>
    1. Start backend: `cd server && npm run dev` (requires .env with API keys + MongoDB)
    2. Start frontend: `cd client && npm run dev`
    3. Open http://localhost:5173
    4. Toggle "Demo Mode" ON (top-right HUD)
    5. Click "The Universe" node — verify 4 child nodes appear below it with smooth animation
    6. Click "Galaxies" node — verify 4 more children appear (tree grows)
    7. Hover over any node — verify a fun fact tooltip appears after ~500ms
    8. Mouse away — verify tooltip disappears
    9. Verify expanded nodes look visually distinct from unexpanded nodes
    10. Toggle "Demo Mode" OFF — verify clicking a new node calls live API (check browser network tab)
    11. Verify the same topic clicked twice doesn't duplicate nodes (expand lock)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `cd server && npx tsc --noEmit` — backend compiles
2. `cd client && npx tsc --noEmit` — frontend compiles
3. Demo mode: click any seed node, 4 children appear with pre-cached data (no API needed)
4. Live mode: click node, network tab shows POST /api/scout, children appear
5. Hover any node: fun fact tooltip appears
6. Second click on same node: nothing happens (already expanded)
7. Cache: repeat API call returns source: 'cache'
</verification>

<success_criteria>
- Clicking a snowball node adds exactly 4 child nodes in a fan layout below it
- Each child node has embedded quiz data in its data property
- Hovering a node shows a fun fact tooltip with 500ms debounce
- Demo mode toggle works and uses pre-cached responses (no network calls)
- Expanded nodes are visually distinct and cannot be re-expanded
- Loading state shows pulse animation on the expanding node
- TypeScript compiles cleanly on both client and server
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-integration/02-02-SUMMARY.md`
</output>
