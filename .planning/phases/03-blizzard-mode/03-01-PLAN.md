---
phase: 03-blizzard-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/state/canvasStore.ts
  - client/src/components/background/ParallaxBackground.tsx
  - client/src/components/background/SnowParticles.tsx
  - client/src/styles/globals.css
  - client/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Snow particles fall continuously with calm intensity in Peace mode"
    - "Triggering Blizzard Mode darkens the sky, intensifies snow, and obscures the cabin"
    - "Transition between modes animates smoothly (sky gradient, particle speed, opacity shifts)"
    - "Exiting Blizzard Mode restores Peace atmosphere"
  artifacts:
    - path: "client/src/components/background/SnowParticles.tsx"
      provides: "tsparticles snow overlay with intensity prop"
    - path: "client/src/state/canvasStore.ts"
      provides: "gameMode state (peace/blizzard), enterBlizzard/exitBlizzard actions, quiz state"
  key_links:
    - from: "client/src/state/canvasStore.ts"
      to: "client/src/components/background/ParallaxBackground.tsx"
      via: "gameMode state drives CSS class changes"
      pattern: "gameMode.*blizzard"
    - from: "client/src/state/canvasStore.ts"
      to: "client/src/components/background/SnowParticles.tsx"
      via: "gameMode determines particle intensity"
      pattern: "gameMode|intensity"
---

<objective>
Add Blizzard Mode atmosphere system: snow particle overlay, game mode state, and smooth visual transitions between Peace and Blizzard modes.

Purpose: This is the foundational "world state" for Phase 3. The atmosphere must shift dramatically when Blizzard Mode activates — sky darkens, snow intensifies, cabin fades — creating the emotional contrast that defines the game.

Output: Snow particles always falling (calm in Peace, intense in Blizzard), sky gradient transitions, cabin opacity changes, and Zustand state management for the full blizzard game loop.
</objective>

<execution_context>
@/Users/sahilpatel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sahilpatel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@client/src/state/canvasStore.ts
@client/src/components/background/ParallaxBackground.tsx
@client/src/components/background/CabinLayer.tsx
@client/src/styles/globals.css
@client/src/App.tsx
@client/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Blizzard Mode state and quiz game loop to Zustand store</name>
  <files>client/src/state/canvasStore.ts</files>
  <action>
    Add game mode state and quiz mechanics to the existing canvasStore:

    **New state fields:**
    - `gameMode: 'peace' | 'blizzard'` (default: 'peace')
    - `blizzardQuiz: { nodeId: string; topic: string; quiz: QuizData; questionIndex: number } | null`
    - `warmth: number` (0-100, starts at 50 when entering blizzard)
    - `quizResult: 'correct' | 'wrong' | null` (for flash feedback, auto-clears after 800ms)
    - `blizzardComplete: boolean` (true when quiz answered, regardless of outcome)

    **New actions:**
    - `enterBlizzard(nodeId: string, topic: string, quiz: QuizData)`: Sets gameMode to 'blizzard', stores quiz data, warmth=50, blizzardComplete=false
    - `answerQuiz(selectedIndex: number)`: Compares to correctIndex. If correct: warmth = Math.min(100, warmth + 25), quizResult='correct'. If wrong: warmth = Math.max(0, warmth - 30), quizResult='wrong'. Sets blizzardComplete=true. After 800ms timeout, clears quizResult to null.
    - `exitBlizzard()`: Resets gameMode to 'peace', clears blizzardQuiz, quizResult, blizzardComplete

    Import `QuizData` type from `../config/api` (already exists with `type` prefix for verbatimModuleSyntax).

    Keep all existing state and actions intact. Just add these new fields alongside them.
  </action>
  <verify>Run `cd client && npx tsc --noEmit` — no type errors. Inspect that existing expandNode/fetchFunFact actions are untouched.</verify>
  <done>canvasStore exports gameMode, warmth, quizResult, blizzardComplete state and enterBlizzard/answerQuiz/exitBlizzard actions with correct types.</done>
</task>

<task type="auto">
  <name>Task 2: Create snow particle overlay and wire atmosphere transitions</name>
  <files>
    client/src/components/background/SnowParticles.tsx
    client/src/components/background/ParallaxBackground.tsx
    client/src/styles/globals.css
    client/src/App.tsx
  </files>
  <action>
    **SnowParticles.tsx** — Create new component using @tsparticles/react (already in package.json):
    - Use `Particles` component from `@tsparticles/react` with `@tsparticles/preset-snow`
    - Accept `intensity: 'calm' | 'blizzard'` prop
    - Calm mode: ~30 particles, slow speed (1-2), low opacity (0.4-0.7), small size (1-3px), gentle wind
    - Blizzard mode: ~150 particles, fast speed (5-10), higher opacity (0.6-1.0), larger size (2-5px), strong sideways wind, more chaotic movement
    - Use `useMemo` for particle options to avoid unnecessary re-renders
    - Position with z-index `var(--z-particles)` (already defined as 20 in globals.css)
    - Use `useEffect` to reload particles when intensity changes (call `container.refresh()` or re-key the component)
    - IMPORTANT: Use `initParticlesEngine` from `@tsparticles/react` and `loadSnowPreset` from `@tsparticles/preset-snow` for initialization. Initialize once on mount with a `useState(false)` flag.

    **ParallaxBackground.tsx** — Add atmosphere transitions:
    - Import `useCanvasStore` and read `gameMode`
    - Add a CSS transition class to the sky gradient div: in peace mode use existing `from-background-dark to-background` gradient; in blizzard mode switch to a darker, more ominous gradient (e.g., `from-[#070d1a] to-[#0f172a]`)
    - Apply CSS `transition: all 1.5s ease-in-out` on the sky gradient div for smooth color shift
    - Wrap the CabinLayer container div with an opacity transition: peace = opacity 1, blizzard = opacity 0.15 (cabin becomes obscured but still faintly visible)
    - Add `transition: opacity 1.5s ease-in-out` to cabin container

    **globals.css** — Add blizzard transition utility if needed:
    - No custom keyframes needed here; transitions are inline. But add a `.blizzard-vignette` class:
      ```css
      .blizzard-vignette {
        box-shadow: inset 0 0 150px 60px rgba(0, 0, 0, 0.7);
        transition: box-shadow 1.5s ease-in-out;
      }
      ```

    **App.tsx** — Wire it all together:
    - Import `SnowParticles` and `useCanvasStore`
    - Read `gameMode` from store
    - Add `<SnowParticles intensity={gameMode === 'blizzard' ? 'blizzard' : 'calm'} />` between ParallaxBackground and InfiniteCanvas (z-index 20 puts it between background and canvas)
    - Add a vignette overlay div that activates during blizzard: `<div className={gameMode === 'blizzard' ? 'blizzard-vignette' : ''} />` as a fixed full-screen div at z-index overlay (30), with `pointer-events-none`
  </action>
  <verify>Run `cd client && npx tsc --noEmit` — no type errors. Run `cd client && npm run build` — builds successfully. Open browser: snow particles should be visible in calm mode. (Blizzard mode can't be triggered yet without UI — that's Plan 02.)</verify>
  <done>Snow particles fall gently in Peace mode. ParallaxBackground has conditional sky/cabin opacity driven by gameMode. Vignette overlay div exists and activates during blizzard. All transitions use 1.5s ease-in-out for smoothness.</done>
</task>

</tasks>

<verification>
1. `cd client && npx tsc --noEmit` passes with no errors
2. `cd client && npm run build` succeeds
3. Snow particles visible in browser (calm intensity)
4. canvasStore has gameMode, warmth, enterBlizzard, answerQuiz, exitBlizzard
5. ParallaxBackground sky gradient and cabin opacity respond to gameMode changes
</verification>

<success_criteria>
- Snow particles always visible (calm mode by default)
- Zustand store has complete blizzard game state (gameMode, warmth, quiz, results)
- Sky gradient, cabin opacity, particle intensity, and vignette all transition smoothly when gameMode changes
- No TypeScript errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-blizzard-mode/03-01-SUMMARY.md`
</output>
